<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Map with Sidebar and Zoom Slider</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  *{box-sizing:border-box;font-family:"Poppins",sans-serif}
  html,body{height:100%;margin:0;background:#87ceeb;overflow:hidden}

  header{
    position:fixed;top:0;left:0;width:100%;height:60px;
    background:linear-gradient(to right,#0288d1,#4fc3f7);
    display:flex;align-items:center;justify-content:center;color:#fff;
    font-size:20px;font-weight:600;z-index:120;box-shadow:0 2px 5px rgba(0,0,0,.2)
  }
  .toggle-btn{position:absolute;left:20px;background:#fff;color:#0288d1;border:0;border-radius:50%;width:42px;height:42px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.2)}
  .next-btn{position:absolute;right:20px;background:#fff;color:#0288d1;border:0;border-radius:20px;padding:8px 14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;box-shadow:0 2px 4px rgba(0,0,0,.2)}

  .sidebar{position:fixed;top:0;left:-250px;width:250px;height:100%;background:#b3e5fc;padding:20px;transition:left .28s;box-shadow:2px 0 5px rgba(0,0,0,.2);z-index:110}
  .sidebar.active{left:0}

  /* map area sits below header */
  .map-container{
    position:relative;width:100%;height:calc(100vh - 60px);top:60px;
    display:flex;align-items:center;justify-content:center;overflow:hidden;
    touch-action:none;cursor:grab;z-index:20;
  }

  /* map-inner is the visual map area with a background image */
  .map-inner{
    position:relative;
    width:100%;
    max-width:1600px;
    aspect-ratio:3509/2480;
    background-image:url('phmap.jpg');
    background-size:contain;
    background-position:center;
    background-repeat:no-repeat;
    transform-origin:center center;
    overflow:visible;
    will-change:transform;
    z-index:10001;
  }

  .map-inner:before{
    content:"";display:block;padding-top:calc(2480/3509*100%);width:100%;height:0;visibility:hidden
  }

  /* pins positioned absolutely inside map-inner */
  .pin{position:absolute;transform:translate(-50%,-100%);cursor:pointer;z-index:2}
  .pin::before{
    content:"\f024";font-family:"Font Awesome 6 Free";font-weight:900;
    display:flex;align-items:center;justify-content:center;
    background:#00bcd4;color:#fff;font-size:10px;width:18px;height:18px;border-radius:50%;
    box-shadow:0 3px 6px rgba(0,0,0,.25)
  }
  .pin.clicked::before {
  background: #008c9e !important; /* darker turquoise */
  transform: scale(1.15);
  box-shadow: 0 0 6px rgba(0,0,0,.35);
}
  .pin.answered::before{background:#4caf50}

  /* popup */
  .popup{position:absolute;top:50%;right:calc(100% + 8px);transform:translateY(-50%);width:140px;background:#fff;border-radius:10px;box-shadow:0 3px 6px rgba(0,0,0,.2);opacity:0;visibility:hidden;transition:all .28s;color:#333;pointer-events:none;z-index:9999}
  .pin .popup{transform-origin:center right;transform:translateY(-50%) scale(calc(1 / var(--zoom,1)))}
  .pin:hover .popup,.pin.clicked .popup{opacity:1;visibility:visible;pointer-events:auto}
  .popup img{width:100%;height:65px;object-fit:cover}
  .popup-content{padding:6px 8px}
  .popup h3{margin:2px 0 0;font-size:12px;font-weight:600}
  .popup p{margin:0 0 6px;color:#777;font-size:10px}
  .popup button{background:#007aff;color:#fff;border:0;border-radius:12px;padding:4px 8px;font-size:10px;cursor:pointer}
  .popup button:hover{background:#0062cc}

  /* FIXED: Form modal now sits below the header and scales properly */
  .form-modal{
    position:fixed;
    top:60px; /* push below header */
    left:0;
    width:100%;
    height:calc(100% - 60px);
    background:rgba(0,0,0,.6);
    display:flex;
    align-items:center;
    justify-content:center;
    visibility:hidden;
    opacity:0;
    transition:all .28s;
    z-index:200; /* above header */
  }
  .form-modal.active{visibility:visible;opacity:1}
  .form-content{
    width:90%;
    max-width:500px;
    max-height:90%;
    background:#fff;
    border-radius:12px;
    overflow:hidden;
    position:relative;
    display:flex;
    flex-direction:column;
    align-items:center;
    animation:fadeIn .25s;
  }
  .form-content iframe{
    width:100%;
    height:400px;
    border:0;
  }
  .close-form{
    position:absolute;top:10px;right:10px;width:28px;height:28px;border-radius:50%;border:0;background:#ddd;cursor:pointer
  }
.done-btn {
  position: absolute;
  bottom: 10px;
  right: 10px;
  background: #4caf50;
  border: none;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 6px rgba(0,0,0,.25);
  color: white;
  font-size: 18px;
}
.done-btn:hover {
  background: #43a047;
}


  .zoom-controls{position:fixed;right:20px;bottom:20px;background:rgba(255,255,255,.9);padding:8px 12px;border-radius:20px;display:flex;gap:8px;align-items:center;z-index:30}

  @keyframes fadeIn{from{transform:scale(.96);opacity:0}to{transform:scale(1);opacity:1}}
  /* FIRST POPUP (Preview Modal) */
/* ✅ Improved Responsive Preview Modal */
.preview-modal {
  position: fixed;
  top: 60px; /* below header */
  left: 0;
  width: 100%;
  height: calc(100% - 60px);
  background: rgba(0,0,0,.6);
  display: flex;
  align-items: center;
  justify-content: center;
  visibility: hidden;
  opacity: 0;
  transition: all .28s;
  z-index: 180;
  padding: 16px; /* prevents edge-clipping */
}

.preview-modal.active {
  visibility: visible;
  opacity: 1;
}

.preview-content {
  width: 100%;
  max-width: 480px;
  max-height: 100%;
  background: #fff;
  border-radius: 14px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: fadeIn .25s;
}

/* ✅ Image adjusts to screen height */
.preview-img {
  width: 100%;
  height: 35vh;          /* responsive height */
  max-height: 260px;     /* limit on desktop */
  object-fit: cover;
}

.preview-text {
  padding: 14px 18px;
  overflow-y: auto;      /* if content longer than space */
  max-height: 200px;     /* keeps buttons visible */
}

.preview-title {
  font-size: 20px;
  font-weight: 600;
  margin: 0 0 4px;
}

.preview-desc {
  margin: 4px 0 12px;
  color: #555;
  font-size: 14px;
}

/* ✅ Buttons always stay visible even if text scrolls */
.preview-btns {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding: 14px;
  border-top: 1px solid #eee;
  background: #fff;
}

.close-preview,
.proceed-preview {
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
}

.close-preview { background: #ddd; }
.proceed-preview { background: #0288d1; color: white; }
.proceed-preview:hover { background: #0072b8; }

/* ✅ Mobile optimization */
@media (max-width: 480px) {
  .preview-content {
    max-width: 95%;
    border-radius: 10px;
  }
  .preview-img {
    height: 30vh;
  }
  .preview-title { font-size: 18px; }
  .preview-desc { font-size: 13px; }
}

</style>
</head>
<body>
<header>
  Exterior Stairs
  <button id="nextBtn" class="next-btn">Next <i class="fa fa-arrow-right"></i></button>
</header>



<div id="mapContainer" class="map-container">
  <div id="mapInner" class="map-inner">
    <div class="pin" data-x="2300" data-y="1105" data-prefill="Left Side Stairs">
      <div class="popup">
        <img src="stair2.jpg" alt="left-stairs"/>
        <div class="popup-content"><h3>Left Side Stairs</h3><p>Click answer to start survey </p><button class="answer-btn"><i class="fa fa-location-arrow"></i> Answer</button></div>
      </div>
    </div>

    <div class="pin" data-x="2740" data-y="1105" data-prefill="Right Side Stairs">
      <div class="popup">
        <img src="stair2.jpg" alt="right-stairs"/>
        <div class="popup-content"><h3>Right Side Stairs</h3><p>Click answer to start survey</p><button class="answer-btn"><i class="fa fa-location-arrow"></i> Answer</button></div>
      </div>
    </div>

    <div class="pin" data-x="2507" data-y="1250" data-prefill="Right Side Stairs">
      <div class="popup">
        <img src="stair2.jpg" alt="front-stairs"/>
        <div class="popup-content"><h3>Front Stairs</h3><p>Click answer to start survey</p><button class="answer-btn"><i class="fa fa-location-arrow"></i> Answer</button></div>
      </div>
    </div>
  </div>
</div>

<div class="zoom-controls">
  <i class="fa fa-search-minus"></i>
  <input id="zoomSlider" type="range" min="1" max="3" step="0.1" value="1"/>
  <i class="fa fa-search-plus"></i>
</div>
<!-- FIRST POPUP: PREVIEW IMAGE & PROCEED -->
<div id="previewModal" class="preview-modal">
  <div class="preview-content">
    <img id="previewImg" class="preview-img" src="" alt="">
    <div class="preview-text">
      <h2 id="previewTitle" class="preview-title"></h2>
      <p class="preview-desc">Review the space before starting the survey.</p>
    </div>

    <div class="preview-btns">
      <button id="closePreview" class="close-preview">Close</button>
      <button id="proceedPreview" class="proceed-preview">Proceed</button>
    </div>
  </div>
</div>

<div id="formModal" class="form-modal">
  <div class="form-content">
    <button id="closeForm" class="close-form">&times;</button>
    <iframe src=""></iframe>
  <button id="doneBtn" class="done-btn">
  <i class="fa fa-check"></i>
</button>
  </div>
</div>

<script>
const mapInner=document.getElementById('mapInner');
const mapContainer=document.getElementById('mapContainer');
const pins=document.querySelectorAll('.pin');
const zoomSlider=document.getElementById('zoomSlider');
const formModal=document.getElementById('formModal');
const formIframe=formModal.querySelector('iframe');
const doneBtn=document.getElementById('doneBtn');
const closeForm=document.getElementById('closeForm');


const IMG_W=3509, IMG_H=2480;
function dbg(...args){console.log('[map-debug]',...args)}
const params = new URLSearchParams(window.location.search);
const userId = params.get("userId");
console.log("User ID:", userId);
function positionPins(){
  const w=mapInner.clientWidth,h=mapInner.clientHeight;
  pins.forEach(pin=>{
    const x=parseFloat(pin.dataset.x),y=parseFloat(pin.dataset.y);
    const leftPct=(x/IMG_W)*100,topPct=(y/IMG_H)*100;
    pin.style.left=`${leftPct}%`;
    pin.style.top=`${topPct}%`;
  });
}
window.addEventListener('load',positionPins);
window.addEventListener('resize',positionPins);
window.addEventListener('orientationchange',positionPins);

let zoom=1,isDragging=false,startX=0,startY=0,offsetX=0,offsetY=0;
function setTransform(){
  mapInner.style.transform=`translate3d(${offsetX}px,${offsetY}px,0) scale(${zoom})`;
  mapInner.style.setProperty('--zoom',zoom);
}
/* ✅ PINCH TO ZOOM (mobile support) */
let initialPinchDistance = null;
let lastZoom = zoom;

mapContainer.addEventListener("touchmove", function (e) {
  if (e.touches.length === 2) {
    e.preventDefault();

    const touch1 = e.touches[0];
    const touch2 = e.touches[1];

    const dx = touch1.pageX - touch2.pageX;
    const dy = touch1.pageY - touch2.pageY;
    const currentDistance = Math.hypot(dx, dy);

    if (initialPinchDistance === null) {
      initialPinchDistance = currentDistance;
      lastZoom = zoom;
      return;
    }

    const pinchRatio = currentDistance / initialPinchDistance;
    zoom = Math.min(3, Math.max(1, lastZoom * pinchRatio)); // clamp between 1–3

    zoomSlider.value = zoom;
    setTransform();
  }
}, { passive: false });

mapContainer.addEventListener("touchend", function (e) {
  if (e.touches.length < 2) {
    initialPinchDistance = null; // reset pinch memory
  }
});

zoomSlider.addEventListener('input',()=>{
  zoom=parseFloat(zoomSlider.value);
  if(zoom<=1){offsetX=0;offsetY=0;}
  setTransform();
});
function getCoords(e){return e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY}}
function startDrag(e){if(zoom<=1)return;const c=getCoords(e);isDragging=true;startX=c.x-offsetX;startY=c.y-offsetY;mapContainer.style.cursor='grabbing'}
function moveDrag(e){if(!isDragging)return;const c=getCoords(e);offsetX=c.x-startX;offsetY=c.y-startY;setTransform()}
function endDrag(){isDragging=false;mapContainer.style.cursor='grab'}
mapContainer.addEventListener('mousedown',startDrag);
mapContainer.addEventListener('mousemove',moveDrag);
mapContainer.addEventListener('mouseup',endDrag);
mapContainer.addEventListener('mouseleave',endDrag);
mapContainer.addEventListener('touchstart',startDrag,{passive:false});
mapContainer.addEventListener('touchmove',moveDrag,{passive:false});
mapContainer.addEventListener('touchend',endDrag);

const formBaseURL='https://docs.google.com/forms/d/e/1FAIpQLSch3JvOiWKwVYo0wWoQsSoBGtY6jZx1i2JLpZfdYvViT3Z-FA/viewform';
const prefillField='entry.674587731';
const locationField = "entry.304709299";
function freshFormURL(label = "") {
  const t = Date.now();
  let url = `${formBaseURL}?t=${t}&embedded=true&usp=pp_url`;

  // Prefill userId
  if (userId) {
    url += `&${prefillField}=${encodeURIComponent(userId)}`;
  }

  // Prefill pin label (the new required field)
  if (label) {
    url += `&${locationField}=${encodeURIComponent(label)}`;
  }
  return url;
}

let watchInterval=null;
function openFormForPin(pin){
  pin.dataset.activePin='true';
  const label=pin.dataset.prefill||'Unknown';
  formIframe.src = freshFormURL(label);
  formModal.classList.add('active');
  clearInterval(watchInterval);
  watchInterval=setInterval(()=>{
    try{
      const href=formIframe.contentWindow.location.href;
      if(href && href.includes('formResponse')){
        markPinAnswered(label);
        clearInterval(watchInterval);
        setTimeout(()=>{formModal.classList.remove('active');formIframe.src='';},800);
      }
    }catch(e){}
  },800);
}
// FIRST: Show preview popup before form
const previewModal = document.getElementById("previewModal");
const previewImg = document.getElementById("previewImg");
const previewTitle = document.getElementById("previewTitle");

document.querySelectorAll('.answer-btn').forEach(btn=>{
  btn.addEventListener('click',e=>{
    e.stopPropagation();
    const pin=e.target.closest('.pin');
    if(!pin)return;

    // Fill preview modal with data from pin popup
    const img = pin.querySelector(".popup img").src;
    const title = pin.querySelector(".popup h3").innerText;

    previewImg.src = img;
    previewTitle.innerText = title;

    previewModal.classList.add("active");

    // store the active pin for Google form later
    pin.dataset.activePin = "true";
  });
});
// Close preview modal
document.getElementById("closePreview").addEventListener("click", () => {
  previewModal.classList.remove("active");
});

// Proceed → open form modal
document.getElementById("proceedPreview").addEventListener("click", () => {
  previewModal.classList.remove("active");

  const active = document.querySelector('[data-active-pin="true"]');
  if (active) openFormForPin(active);
});

pins.forEach(pin => {
  pin.addEventListener("click", e => {
    if (e.target.closest(".answer-btn")) return; // ignore button clicks
    e.stopPropagation();

    const isAlreadyOpen = pin.classList.contains("clicked");

    // close all popups
    pins.forEach(p => p.classList.remove("clicked"));

    // only open if it wasn't open already
    if (!isAlreadyOpen) {
      pin.classList.add("clicked");
    }
  });
});

document.addEventListener('click',()=>pins.forEach(p=>p.classList.remove('clicked')));

function loadAnsweredPins(){
  const answered=JSON.parse(localStorage.getItem('answeredPins')||'[]');
  answered.forEach(label=>{
    const p=document.querySelector(`.pin[data-prefill="${label}"]`);
    if(p)p.classList.add('answered');
  });
}
function markPinAnswered(label){
  if(!label)return;
  const arr=JSON.parse(localStorage.getItem('answeredPins')||'[]');
  if(!arr.includes(label))arr.push(label);
  localStorage.setItem('answeredPins',JSON.stringify(arr));
  const p=document.querySelector(`.pin[data-prefill="${label}"]`);
  if(p)p.classList.add('answered');
}
loadAnsweredPins();

doneBtn.addEventListener('click',()=>{
  const active=document.querySelector('[data-active-pin="true"]');
  if(active){
    const label=active.dataset.prefill||'Unknown';
    markPinAnswered(label);
    delete active.dataset.activePin;
  }
  clearInterval(watchInterval);
  formModal.classList.remove('active');
  formIframe.src='';
});
closeForm.addEventListener('click',()=>{
  clearInterval(watchInterval);
  const active=document.querySelector('[data-active-pin="true"]');
  if(active)delete active.dataset.activePin;
  formModal.classList.remove('active');
  formIframe.src='';
});
formModal.addEventListener('click',ev=>{if(ev.target===formModal)closeForm.click()});

// --- Navigation between selected pages ---
document.getElementById("nextBtn").addEventListener("click", () => {
  const selectedPages = JSON.parse(localStorage.getItem("selectedPages") || "[]");
  let currentIndex = parseInt(localStorage.getItem("currentPageIndex") || "0", 10);

  if (currentIndex < selectedPages.length - 1) {
    currentIndex++;
    localStorage.setItem("currentPageIndex", currentIndex.toString());

    const nextPage = selectedPages[currentIndex];
    if (nextPage) {
      const params = new URLSearchParams(window.location.search);
      const userId = params.get("userId");
      const nextUrl = userId
        ? `${nextPage}?userId=${encodeURIComponent(userId)}`
        : nextPage;

      window.location.href = nextUrl;
    }
  } else {
    alert("✅ You’ve completed all selected areas!");
    localStorage.removeItem("selectedPages");
    localStorage.removeItem("currentPageIndex");
  }
});

</script>
</body>
</html>
